name: Build Video Downloader

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/video/downloader/**'
      - 'src/mediatools/video/downloader/**'
      - 'docker/video-downloader/**'
      - '.github/workflows/build-video-downloader.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'apps/video/downloader/**'
      - 'src/mediatools/video/downloader/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  APP_NAME: mt-vdl
  DOCKER_IMAGE_NAME: video-downloader

jobs:
  # ============================================================================
  # Job 1: Generate version info from app's version.txt
  # ============================================================================
  generate-version:
    name: Generate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_tag: ${{ steps.version.outputs.build_tag }}
      should_release: ${{ steps.version.outputs.should_release }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version and generate build info
        id: version
        run: |
          # Read app version
          APP_VERSION=$(cat src/mediatools/video/downloader/data/version.txt)
          BUILD_NUM=$(git rev-list --count HEAD)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          FULL_VERSION="${APP_VERSION}-build.${BUILD_NUM}"
          BUILD_TAG="vdl-v${APP_VERSION}-build.${BUILD_NUM}+${COMMIT_HASH}"
          
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          
          # Only release on main branch push
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          echo "üì¶ App Version: $APP_VERSION"
          echo "üè∑Ô∏è  Full Version: $FULL_VERSION"
          echo "üîñ Build Tag: $BUILD_TAG"

  # ============================================================================
  # Job 2: Windows Builds
  # ============================================================================
  build-windows-onedir:
    runs-on: windows-latest
    needs: generate-version
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12.3
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.3'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install Windows-specific dependencies
      run: |
        pip install winshell pywin32

    - name: Build Windows Portable (--onedir)
      shell: bash
      run: |
        cd apps/video/downloader/build
        chmod +x build_onedir.sh
        ./build_onedir.sh
        
    - name: Create Windows Portable ZIP
      run: |
        $mainFolder = "mt-vdl-Windows-Portable"
        New-Item -ItemType Directory -Path $mainFolder -Force
        Copy-Item -Path "apps\video\downloader\build\dist\mt-vdl\*" -Destination $mainFolder\ -Recurse -Force
        Compress-Archive -Path "$mainFolder" -DestinationPath "mt-vdl-Windows-Portable.zip" -Force
        Remove-Item -Recurse -Force $mainFolder
        
    - name: Upload Windows Portable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mt-vdl-Windows-Portable
        path: mt-vdl-Windows-Portable.zip

  build-windows-onefile:
    runs-on: windows-latest
    needs: generate-version
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12.3
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.3'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install Windows-specific dependencies
      run: |
        pip install winshell pywin32

    - name: Build Windows Single File (--onefile)
      shell: bash
      run: |
        cd apps/video/downloader/build
        chmod +x build_onefile.sh
        ./build_onefile.sh
        
    - name: Upload Windows Single File Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mt-vdl-Windows.exe
        path: apps/video/downloader/build/dist/mt-vdl.exe

  # ============================================================================
  # Job 3: Linux Builds
  # ============================================================================
  build-linux-onedir:
    runs-on: ubuntu-latest
    needs: generate-version
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12.3
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.3'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build Linux Portable (--onedir)
      run: |
        cd apps/video/downloader/build
        chmod +x build_onedir.sh
        ./build_onedir.sh
        
    - name: Create Linux Portable ZIP
      run: |
        mkdir -p mt-vdl-Linux-Portable
        cp -r apps/video/downloader/build/dist/mt-vdl/* mt-vdl-Linux-Portable/
        zip -r mt-vdl-Linux-Portable.zip mt-vdl-Linux-Portable/
        rm -rf mt-vdl-Linux-Portable
        
    - name: Upload Linux Portable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mt-vdl-Linux-Portable
        path: mt-vdl-Linux-Portable.zip

  build-linux-onefile:
    runs-on: ubuntu-latest
    needs: generate-version
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12.3
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.3'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build Linux Single File (--onefile)
      run: |
        cd apps/video/downloader/build
        chmod +x build_onefile.sh
        ./build_onefile.sh
        
    - name: Upload Linux Single File Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mt-vdl-Linux
        path: apps/video/downloader/build/dist/mt-vdl

  # ============================================================================
  # Job 4: macOS Builds (COMMENTED OUT - enable when ready to test)
  # ============================================================================
  # build-macos-onedir:
  #   runs-on: macos-latest
  #   needs: generate-version
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     
  #   - name: Set up Python 3.12.3
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.12.3'
  #       
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements.txt
  #       pip install pyinstaller
  #       
  #   - name: Build macOS Portable (--onedir)
  #     run: |
  #       rm -rf build dist
  #       python -m PyInstaller \
  #         --onedir \
  #         --windowed \
  #         --name "mt-vdl" \
  #         --paths="./src" \
  #         --icon="src/mediatools/video/downloader/assets/icon.ico" \
  #         --add-data="src/mediatools/video/downloader/data:data" \
  #         --add-data="src/mediatools/video/downloader/bin:bin" \
  #         --add-data="src/mediatools/video/downloader/utils/cleanup_files.sh:utils" \
  #         --add-data="src/mediatools/video/downloader/assets:assets" \
  #         --add-data="apps/video/downloader/docs/UserGuide.pdf:docs" \
  #         --add-data="README.md:docs" \
  #         --add-data="LICENSE:docs" \
  #         --hidden-import=mediatools \
  #         --hidden-import=mediatools.video.downloader \
  #         --hidden-import=mediatools.video.downloader.core \
  #         --hidden-import=mediatools.video.downloader.gui \
  #         --hidden-import=mediatools.video.downloader.utils \
  #         --hidden-import=mediatools.video.downloader.compat \
  #         --clean \
  #         apps/video/downloader/launch.py
  #       
  #   - name: Create macOS Portable Archive
  #     run: |
  #       mkdir -p mt-vdl-macOS-Portable
  #       cp -r dist/mt-vdl/* mt-vdl-macOS-Portable/
  #       tar -czf mt-vdl-macOS-Portable.tar.gz mt-vdl-macOS-Portable/
  #       rm -rf mt-vdl-macOS-Portable
  #       
  #   - name: Upload macOS Portable Artifact
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: mt-vdl-macOS-Portable
  #       path: mt-vdl-macOS-Portable.tar.gz

  # build-macos-onefile:
  #   runs-on: macos-latest
  #   needs: generate-version
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     
  #   - name: Set up Python 3.12.3
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.12.3'
  #       
  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements.txt
  #       pip install pyinstaller
  #       
  #   - name: Build macOS Single File (--onefile)
  #     run: |
  #       rm -rf build dist
  #       python -m PyInstaller \
  #         --onefile \
  #         --windowed \
  #         --name "mt-vdl" \
  #         --paths="./src" \
  #         --icon="src/mediatools/video/downloader/assets/icon.ico" \
  #         --add-data="src/mediatools/video/downloader/data:data" \
  #         --add-data="src/mediatools/video/downloader/bin:bin" \
  #         --add-data="src/mediatools/video/downloader/utils/cleanup_files.sh:utils" \
  #         --add-data="src/mediatools/video/downloader/assets:assets" \
  #         --add-data="apps/video/downloader/docs/UserGuide.pdf:docs" \
  #         --add-data="README.md:docs" \
  #         --add-data="LICENSE:docs" \
  #         --hidden-import=mediatools \
  #         --hidden-import=mediatools.video.downloader \
  #         --hidden-import=mediatools.video.downloader.core \
  #         --hidden-import=mediatools.video.downloader.gui \
  #         --hidden-import=mediatools.video.downloader.utils \
  #         --hidden-import=mediatools.video.downloader.compat \
  #         --clean \
  #         apps/video/downloader/launch.py
  #       
  #   - name: Upload macOS Single File Artifact
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: mt-vdl-macOS
  #       path: dist/mt-vdl

  # ============================================================================
  # Job 5: Build and Push Docker Image
  # ============================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [generate-version, build-windows-onedir, build-windows-onefile, build-linux-onedir, build-linux-onefile]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
            ghcr.io/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value=latest,enable=${{ needs.generate-version.outputs.should_release == 'true' }}
            type=raw,value=${{ needs.generate-version.outputs.version }}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./docker/video-downloader
          file: ./docker/video-downloader/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update Docker Hub Description
        if: github.event_name != 'pull_request' && needs.generate-version.outputs.should_release == 'true'
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
          readme-filepath: ./docker/video-downloader/README.md
          short-description: "MediaTools Video Downloader - Cross-platform video downloader with yt-dlp"
        continue-on-error: true

  # ============================================================================
  # Job 6: Create/Update Release (only if all builds succeed on main branch)
  # ============================================================================
  create-release:
    runs-on: ubuntu-latest
    needs: [generate-version, build-windows-onedir, build-windows-onefile, build-linux-onedir, build-linux-onefile, build-docker]
    if: needs.generate-version.outputs.should_release == 'true'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Display downloaded files
      run: ls -R artifacts/
      
    - name: Prepare release files
      run: |
        # Copy and rename files
        cp artifacts/mt-vdl-Linux-Portable/mt-vdl-Linux-Portable.zip .
        cp artifacts/mt-vdl-Windows-Portable/mt-vdl-Windows-Portable.zip .
        cp artifacts/mt-vdl-Windows.exe/mt-vdl.exe mt-vdl-Windows.exe
        cp artifacts/mt-vdl-Linux/mt-vdl mt-vdl-Linux
        
        # Make Linux executable executable
        chmod +x mt-vdl-Linux
        
        echo "‚úÖ Release files prepared:"
        ls -la mt-vdl-Windows-Portable.zip mt-vdl-Windows.exe mt-vdl-Linux-Portable.zip mt-vdl-Linux
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        name: "MediaTools Video Downloader - v${{ needs.generate-version.outputs.version }}"
        body: |
          # MediaTools Video Downloader
          
          **Version:** ${{ needs.generate-version.outputs.version }}
          **Build Tag:** `${{ needs.generate-version.outputs.build_tag }}`
          **Commit:** ${{ github.sha }}
          
          ---
          
          ## ‚úÖ All Builds Passed
          
          This release is automatically updated only when **all builds succeed**:
          - ‚úÖ Windows executable builds passed
          - ‚úÖ Linux executable builds passed
          - ‚úÖ Docker multi-arch builds passed
          
          ---
          
          ## üì• Available Downloads
          
          ### Windows
          1. **mt-vdl-Windows-Portable.zip** - Portable folder (--onedir)
            - Contains `mt-vdl.exe` + all dependencies
            - Extract and run `mt-vdl.exe`
            
          2. **mt-vdl-Windows.exe** - Single executable (--onefile)
            - Single file, self-contained
            - Run directly
            
          ### Linux
          3. **mt-vdl-Linux-Portable.zip** - Portable folder (--onedir)
            - Contains `mt-vdl` binary + all dependencies
            - Extract and run `./mt-vdl`
            
          4. **mt-vdl-Linux** - Single executable (--onefile)
            - Single binary file
            - Run with `./mt-vdl`
          
          ### Docker
          ```bash
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/video-downloader:latest
          docker pull ghcr.io/${{ github.repository_owner }}/video-downloader:latest
          ```
          
          ---
          
          ## Usage Notes
          - Windows: May trigger antivirus (false positive)
          - Linux: Make executable with `chmod +x mt-vdl-Linux`
          - Portable versions are recommended for better performance
          
        files: |
          mt-vdl-Windows-Portable.zip
          mt-vdl-Windows.exe
          mt-vdl-Linux-Portable.zip
          mt-vdl-Linux